---
layout: default
title: Leaderboard
---

<div class="centered" id="compare-input">
    <form action="#" onsubmit="compareStats()">
        <input type="text" id="player1" placeholder="Player1...">
        <input type="text" id="player2" placeholder="Player2...">
    </form>
    <button type="button" onclick="compareStats()">Compare!</button>
</div>

<br>

<div id="player-results-container">
    <div class="player-results-child" id="player1-results"></div>
    <span></span>
    <div class="player-results-child" id="player2-results"></div>
</div>

<br>

<p class="centered" id="loading-text" hidden>Loading...</p>
<table id="leaderboard-table">
    <tr>
        <th>Player</th>
        <th>Kills</th>
        <th>Deaths</th>
        <th>Wins</th>
        <th>Flawless Wins</th>
        <th>Losses</th>
        <th>Play Time</th>
        <th>Tokens</th>
    </tr>
</table>

<br>

<button type="button" class="centered" id="prev-page" onclick="getPageAndAddToTable(--pageNumber, 10, {})">Prev Page</button>
<button type="button" class="centered" id="next-page" onclick="getPageAndAddToTable(++pageNumber, 10, {})">Next Page</button>

<p id="page-counter">Page 1/1</p>

<script>
    const apiUrl = "http://localhost:15613";
    const Comparator = Object.freeze({
        NONE: Symbol("none"),
        GREATER: Symbol("greater"),
        LESS: Symbol("less")
    });
    const formattedStats = {
        // "Player": Comparator.NONE,
        "Kills": Comparator.GREATER,
        "Deaths": Comparator.LESS,
        "Wins": Comparator.GREATER,
        "Flawless Wins": Comparator.GREATER,
        "Losses": Comparator.LESS,
        "Play Time": Comparator.NONE,
        "Tokens": Comparator.GREATER
    };

    const prevBtn = document.getElementById("prev-page");
    const nextBtn = document.getElementById("next-page");
    const loadingElement = document.getElementById("loading-text");

    let pageNumber = 1;
    let totalData = 1;

    function dhm(ms) {
        const days = Math.floor(ms / (24 * 60 * 60 * 1000));
        const daysms = ms % (24 * 60 * 60 * 1000);
        const hours = Math.floor(daysms / (60 * 60 * 1000));
        const hoursms = ms % (60 * 60 * 1000);
        const minutes = Math.floor(hoursms / (60 * 1000));
        const minutesms = ms % (60 * 1000);
        const sec = Math.floor(minutesms / 1000);
        return `${days}d ${hours}h ${minutes}m`;
    }

    function reassembleTable() {
        let table = document.getElementById("leaderboard-table");
        let footer = table.createTFoot();
        let row = footer.insertRow(0);

    }

    // function clearRows() {
    //     Array.from(document.getElementById("leaderboard-table")).forEach(e => e.innerHTML = "");
    // }

    async function compareStats() {
        Array.from(document.getElementsByClassName("player-results-child")).forEach(e => e.innerHTML = "");

        let player1 = document.getElementById("player1").value;
        let player2 = document.getElementById("player2").value;

        if (player1.length == 0 || player2.length == 0) {
            alert("Missing one or more input for player names");
            return;
        }

        if (player1 === player2) {
            alert("Why are you comparing yourself?\n\nWhy are you comparing yourself?");
        }

        let player1Response = await fetch(`${apiUrl}/ssbstats?name=${player1}`);
        let player2Response = await fetch(`${apiUrl}/ssbstats?name=${player2}`);

        let player1Stats = await player1Response.json();
        let player2Stats = await player2Response.json();

        if (player1Stats.hasOwnProperty("error") || player2Stats.hasOwnProperty("error")) {
            alert("Could not get stats of one or more players");
            return;
        }

        const sections = document.getElementsByClassName("player-results-child");
        let leftPlayer = sections[0];
        let rightPlayer = sections[1];

        const leftHeader = document.createElement("h3");
        const rightHeader = document.createElement("h3");
        leftHeader.classList.add("centered");
        leftHeader.innerHTML = `${player1Stats.playerName}'s Stats`;
        rightHeader.classList.add("centered");
        rightHeader.innerHTML = `${player2Stats.playerName}'s Stats`;
        const br = document.createElement("br");
        const br2 = document.createElement("br");
        const leftTable = document.createElement("table");
        leftTable.classList.add("player-results-table");

        const rightTable = document.createElement("table");
        rightTable.classList.add("player-results-table");

        for (const [formattedStat, comparator] of Object.entries(formattedStats)) {
            // console.log(formattedStat);
            const leftTableRow = leftTable.insertRow();
            const leftFirstCell = leftTableRow.insertCell();
            leftFirstCell.innerHTML = formattedStat;

            const leftSecondCell = leftTableRow.insertCell();

            const rightTableRow = rightTable.insertRow();
            const rightFirstCell = rightTableRow.insertCell();
            rightFirstCell.innerHTML = formattedStat;

            const rightSecondCell = rightTableRow.insertCell();

            let leftValue = player1Stats.stats[formattedStat] ?? 0;
            leftSecondCell.innerHTML = leftValue;

            let rightValue = player2Stats.stats[formattedStat] ?? 0;
            rightSecondCell.innerHTML = rightValue;

            let result;
            switch (comparator) {
                case Comparator.GREATER:
                    result = leftValue > rightValue;
                    break;
                case Comparator.LESS:
                    result = leftValue < rightValue;
                    break;
            }
            if (typeof result === "boolean") {
                if (result) {
                    leftSecondCell.classList.add("greater-entry");
                    rightSecondCell.classList.add("lesser-entry");
                } else {
                    leftSecondCell.classList.add("lesser-entry");
                    rightSecondCell.classList.add("greater-entry");
                }
            }
        }
        leftPlayer.appendChild(leftHeader);
        leftPlayer.appendChild(br);
        leftPlayer.appendChild(leftTable);

        rightPlayer.appendChild(rightHeader);
        rightPlayer.appendChild(br2);
        rightPlayer.appendChild(rightTable);
    }

    async function getPageAndAddToTable(page, amount, parameters) {
        loadingElement.hidden = false;
        let table = document.getElementById("leaderboard-table");
        table.getElementsByTagName("tbody")[0].innerHTML = table.rows[0].innerHTML;
        let url = apiUrl + "/leaderboard";
        if (page > 0) parameters["page"] = page;
        let i = 0;
        if (Object.keys(parameters).length > 0) {
            for (const [key, value] of Object.entries(parameters)) {
                if (i == 0)
                    url += "?";
                else
                    url += "&";
                url += `${key}=${value}`;
                i++;
            }
        }
        console.log(url)
        let response = await fetch(url);
        let data = await response.json()
            .then(data => {
                console.log(data);
                totalData = data.totalData;
                let allPlayerStats = data.playerStatistics;
                for (let i = 0; i < Object.keys(allPlayerStats).length; i++) {
                    let playerInfo = allPlayerStats[i].player;
                    let playerStatistics = allPlayerStats[i].statistics;

                    let row = table.insertRow(i + 1);
                    row.insertCell().innerHTML = playerInfo.name;
                    for (const [key, value] of Object.entries(playerStatistics)) {
                        if (key === "Play Time") {
                            let seconds = dhm(value);
                            row.insertCell().innerHTML = seconds;
                            continue;
                        }
                        let cell = row.insertCell();
                        cell.innerHTML = value;
                    }
                }

            });
        let totalPages = Math.ceil(totalData / amount);
        loadingElement.hidden = true;
        prevBtn.disabled = page == 1;
        nextBtn.disabled = page == totalPages;
        document.getElementById("page-counter").innerHTML = `Page ${pageNumber}/${totalPages}`;
    }

    getPageAndAddToTable(pageNumber, 10, {});
</script>
