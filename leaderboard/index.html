---
layout: default
title: Leaderboard
---

<div class="centered" id="compare-input">
    <form action="#" onsubmit="compareStats()">
        <input type="text" id="player1" placeholder="Player1...">
        <input type="text" id="player2" placeholder="Player2...">
    </form>
    <button type="button" onclick="compareStats()">Compare!</button>
</div>

<br>

<div id="player-results-container">
    <div class="player-results-child" id="player1-results"></div>
    <span> </span>
    <div class="player-results-child" id="player2-results"></div>
</div>

<br>

<p class="centered" id="loading-text" hidden>Loading...</p>
<table id="leaderboard-table">
    <tr>
        <th>Player</th>
        <th class="clickable" onclick="sortTable('kills')">Kills</th>
        <th class="clickable" onclick="sortTable('deaths')">Deaths</th>
        <th class="clickable" onclick="sortTable('wins')">Wins</th>
        <th class="clickable" onclick="sortTable('flawless wins')">Flawless Wins</th>
        <th class="clickable" onclick="sortTable('losses')">Losses</th>
        <th class="clickable" onclick="sortTable('play time')">Play Time</th>
        <th class="clickable" onclick="sortTable('tokens')">Tokens</th>
    </tr>
</table>

<br>

<button type="button" class="centered" id="prev-page" onclick="getPageAndAddToTable(pageNumber - 1, 10, {})">Prev Page</button>
<button type="button" class="centered" id="next-page" onclick="getPageAndAddToTable(pageNumber + 1, 10, {})">Next Page</button>

<p id="page-counter">Page 1/1</p>

<script>
    const apiUrl = "http://localhost:15613";
    const Comparator = Object.freeze({
        NONE: Symbol("none"),
        GREATER: Symbol("greater"),
        LESS: Symbol("less")
    });
    const SortType = Object.freeze({
        ASCENDING: Symbol("asc"),
        DESCENDING: Symbol("desc")
    });
    
    const statComparisonMap = {
        // "Player": Comparator.NONE,
        "Kills": Comparator.GREATER,
        "Deaths": Comparator.NONE,
        "KDR": Comparator.GREATER,
        "Wins": Comparator.GREATER,
        "Flawless Wins": Comparator.GREATER,
        "Losses": Comparator.NONE,
        "Play Time": Comparator.GREATER,
        "Tokens": Comparator.GREATER
    };

    const leaderboardStatMap = [
        "Kills",
        "Deaths",
        "Wins",
        "Flawless Wins",
        "Losses",
        "Play Time",
        "Tokens"
    ];

    const prevBtn = document.getElementById("prev-page");
    const nextBtn = document.getElementById("next-page");
    const loadingElement = document.getElementById("loading-text");

    const minecraftBody = (uuid) => `https://minotar.net/armor/body/${uuid}/100.png`;

    let totalData = 1;

    // parameters
    let pageNumber = 1;
    let sortBy = "kills";
    let sortDirection = SortType.DESCENDING;

    function dhm(ms) {
        const days = Math.floor(ms / (24 * 60 * 60 * 1000));
        const daysms = ms % (24 * 60 * 60 * 1000);
        const hours = Math.floor(daysms / (60 * 60 * 1000));
        const hoursms = ms % (60 * 60 * 1000);
        const minutes = Math.floor(hoursms / (60 * 1000));
        const minutesms = ms % (60 * 1000);
        const sec = Math.floor(minutesms / 1000);
        return `${days}d ${hours}h ${minutes}m`;
    }

    function waitForImage(imgElem) {
        return new Promise(res => {
            if (imgElem.complete) {
                return res();
            }
            imgElem.onload = () => res();
            imgElem.onerror = () => res();
        })
    };

    function getSortingString(sortDirection) {
        switch (sortDirection) {
            case SortType.ASCENDING:
                return "asc";
            case SortType.DESCENDING:
                return "desc";
        }
    }

    function formatStat(stat, value) {
        if (stat === "Play Time") {
            return dhm(value);
        }
        else if (stat === "KDR") {
            return Number(value).toFixed(2);
        }

        return value;
    }

    function reassembleTable() {
        let table = document.getElementById("leaderboard-table");
        let footer = table.createTFoot();
        let row = footer.insertRow(0);

    }

    // function clearRows() {
    //     Array.from(document.getElementById("leaderboard-table")).forEach(e => e.innerHTML = "");
    // }

    async function compareStats() {
        let player1 = document.getElementById("player1").value;
        let player2 = document.getElementById("player2").value;

        if (player1.length == 0 || player2.length == 0) {
            alert("Missing one or more input for player names");
            return;
        }

        if (player1 === player2) {
            alert("Why are you comparing yourself?\n\nWhy are you comparing yourself?");
        }

        let player1Response = await fetch(`${apiUrl}/ssbstats?name=${player1}`);
        let player2Response = await fetch(`${apiUrl}/ssbstats?name=${player2}`);

        let player1Stats = await player1Response.json();
        let player2Stats = await player2Response.json();

        if (player1Stats.hasOwnProperty("error") || player2Stats.hasOwnProperty("error")) {
            alert("Could not get stats of one or more players");
            return;
        }

        player1Stats.stats["KDR"] = (player1Stats.stats.Kills ?? 0) / (player1Stats.stats.Deaths ?? 1);
        player2Stats.stats["KDR"] = (player2Stats.stats.Kills ?? 0) / (player2Stats.stats.Deaths ?? 1);

        const sections = document.getElementsByClassName("player-results-child");
        let leftPlayer = sections[0];
        let rightPlayer = sections[1];

        const leftHeader = document.createElement("h3");
        const leftImage = document.createElement("img");
        leftImage.src = minecraftBody(player1Stats.uuid);
        leftImage.classList.add("player-img");
        const rightHeader = document.createElement("h3");
        const rightImage = document.createElement("img");
        rightImage.src = minecraftBody(player2Stats.uuid);
        rightImage.classList.add("player-img");
        leftHeader.classList.add("centered");
        leftHeader.innerHTML = `${player1Stats.playerName}'s Stats`;
        rightHeader.classList.add("centered");
        rightHeader.innerHTML = `${player2Stats.playerName}'s Stats`;
        const br = document.createElement("br");
        const br2 = document.createElement("br");
        const leftTable = document.createElement("table");
        leftTable.classList.add("player-results-table");

        const rightTable = document.createElement("table");
        rightTable.classList.add("player-results-table");

        for (const [formattedStat, comparator] of Object.entries(statComparisonMap)) {
            // console.log(formattedStat);
            const leftTableRow = leftTable.insertRow();
            const leftFirstCell = leftTableRow.insertCell();
            leftFirstCell.innerHTML = formattedStat;

            const leftSecondCell = leftTableRow.insertCell();

            const rightTableRow = rightTable.insertRow();
            const rightFirstCell = rightTableRow.insertCell();
            rightFirstCell.innerHTML = formattedStat;

            const rightSecondCell = rightTableRow.insertCell();

            let leftValue = player1Stats.stats[formattedStat] ?? 0;
            let rightValue = player2Stats.stats[formattedStat] ?? 0;

            let result;
            switch (comparator) {
                case Comparator.GREATER:
                    result = leftValue > rightValue;
                    break;
                case Comparator.LESS:
                    result = leftValue < rightValue;
                    break;
            }
            if (typeof result === "boolean") {
                if (result) {
                    leftSecondCell.classList.add("greater-entry");
                    rightSecondCell.classList.add("lesser-entry");
                } else {
                    leftSecondCell.classList.add("lesser-entry");
                    rightSecondCell.classList.add("greater-entry");
                }
            }
            leftSecondCell.innerHTML = formatStat(formattedStat, leftValue);
            rightSecondCell.innerHTML = formatStat(formattedStat, rightValue);
        }
        await waitForImage(leftImage);
        await waitForImage(rightImage);

        Array.from(document.getElementsByClassName("player-results-child")).forEach(e => e.innerHTML = "");

        leftPlayer.appendChild(leftHeader);
        leftPlayer.appendChild(leftImage);
        leftPlayer.appendChild(br);
        leftPlayer.appendChild(leftTable);

        rightPlayer.appendChild(rightHeader);
        rightPlayer.appendChild(rightImage);
        rightPlayer.appendChild(br2);
        rightPlayer.appendChild(rightTable);
    }

    /**
     * Sorts the table using the input sorting method and resets the table to page 1.
     * If the input sorting method is the same as the current method, the method simply
     * toggles the sorting direction.
     * 
     * @param {string} The method to sort
     */
    function sortTable(sortingBy) {
        if (sortBy === sortingBy) { // if the new sorting value is same as old, simply toggle whether it is ascending or descending
            if (sortDirection === SortType.ASCENDING)
                sortDirection = SortType.DESCENDING;
            else
                sortDirection = SortType.ASCENDING;
        } else {
            sortBy = sortingBy;
            sortDirection = SortType.DESCENDING;
        }
        // set the table to the first page
        getPageAndAddToTable(1, 10);
    }

    async function getPageAndAddToTable(page, amount) {
        loadingElement.hidden = false;
        pageNumber = page;
        let table = document.getElementById("leaderboard-table");
        let url = `${apiUrl}/leaderboard?page=${page}&sortBy=${sortBy}&sortType=${getSortingString(sortDirection)}`;
        let i = 0;
        console.log(url)
        let response = await fetch(url);
        let data = await response.json()
            .then(data => {
                        // clear table
                table.getElementsByTagName("tbody")[0].innerHTML = table.rows[0].innerHTML;
                console.log(data);
                totalData = data.totalData;
                let allPlayerStats = data.playerStatistics;
                for (let i = 0; i < Object.keys(allPlayerStats).length; i++) {
                    let playerInfo = allPlayerStats[i].player;
                    let playerStatistics = allPlayerStats[i].statistics;

                    let row = table.insertRow(i + 1);
                    row.insertCell().innerHTML = playerInfo.name;

                    leaderboardStatMap.forEach(formattedStat => {
                        let value = playerStatistics[formattedStat] ?? 0;
                        let cell = row.insertCell();
                        cell.innerHTML = formatStat(formattedStat, value);
                    });
                }

            });
        let totalPages = Math.ceil(totalData / amount);
        loadingElement.hidden = true;
        prevBtn.disabled = page == 1;
        nextBtn.disabled = page == totalPages;
        document.getElementById("page-counter").innerHTML = `Page ${pageNumber}/${totalPages}`;
    }

    getPageAndAddToTable(pageNumber, 10, {});
</script>
